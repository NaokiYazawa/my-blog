name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# ä¸¦è¡Œãƒ“ãƒ«ãƒ‰ã®åˆ¶å¾¡
# æ ¹æ‹ : åŒã˜ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰è¤‡æ•°ã® push ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãƒªã‚½ãƒ¼ã‚¹ã‚’åŠ¹ç‡åŒ–
# PR ã®å ´åˆã¯æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã§å¤ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€main ã®å ´åˆã¯é †åºã‚’ä¿è¨¼
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  deploy:
    # Draft PR ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¯€ç´„
    # æ ¹æ‹ : GitHub Actions ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ - é–‹ç™ºä¸­ã®ä¸å®Œå…¨ãªçŠ¶æ…‹ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é¿ã‘ã‚‹
    if: github.event.pull_request.draft == false || github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Deploy
    timeout-minutes: 15

    permissions:
      contents: read
      deployments: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # postinstall ã§ contentlayer2 build ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
      - name: Install dependencies
        run: npm ci

      # Contentlayer ã®ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
      # æ ¹æ‹ : postinstall ã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒ“ãƒ«ãƒ‰ã®æˆåŠŸã‚’ç¢ºèªã—ã€æ—©æœŸã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
      - name: Verify Contentlayer build
        run: |
          if [ ! -d ".contentlayer" ]; then
            echo "âŒ Error: Contentlayer build failed"
            exit 1
          fi
          echo "âœ… Contentlayer generated $(find .contentlayer -name '*.json' | wc -l) documents"

      # Next.js ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      # æ ¹æ‹ : GitHub Actions ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ - ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’ 30-40% å‰Šæ¸›
      # .next/cache ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ã€å¢—åˆ†ãƒ“ãƒ«ãƒ‰ãŒé«˜é€ŸåŒ–ã•ã‚Œã‚‹
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥:
      # - key: ä¾å­˜é–¢ä¿‚ (package-lock.json) ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®ã¿æ–°ã—ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
      # - restore-keys: ä¾å­˜é–¢ä¿‚ãŒåŒã˜ãªã‚‰éå»ã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†åˆ©ç”¨
      # - Next.js ã®å¢—åˆ†ãƒ“ãƒ«ãƒ‰æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã‚‚é«˜é€Ÿã«ãƒ“ãƒ«ãƒ‰å¯èƒ½
      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      # OpenNext Cloudflare ãƒ“ãƒ«ãƒ‰
      # æ ¹æ‹ : OpenNext å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (Trust Score: 7.4)
      # - å…¬å¼ã§ã¯ "npx opennextjs-cloudflare build" ã‚’å˜ç‹¬ã§ä½¿ç”¨
      # - SKIP_NEXT_APP_BUILD ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ã‹ã‚‰ã€å†…éƒ¨ã§ next build ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹
      # - package.json ã® "preview" ã¨ "deploy" ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚åŒæ§˜ã«å˜ç‹¬ã§ä½¿ç”¨
      # é‡è¦: npm run build ã‚’å‰Šé™¤ã—ã€opennextjs-cloudflare build ã®ã¿å®Ÿè¡Œ
      - name: Build for Cloudflare
        run: npx opennextjs-cloudflare build
        env:
          NODE_ENV: production

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      # æ ¹æ‹ : ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã—ã€æ—©æœŸã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º
      - name: Verify build output
        run: |
          if [ ! -f ".open-next/worker.js" ]; then
            echo "âŒ Error: OpenNext build failed - worker.js not found"
            exit 1
          fi
          echo "âœ… Build output verified"
          echo "Worker size: $(du -h .open-next/worker.js | cut -f1)"
          echo "Assets directory size: $(du -sh .open-next/assets | cut -f1)"

      # Cloudflare Workers ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      # æ ¹æ‹ : cloudflare/wrangler-action å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (Trust Score: 9.3)
      # - gitHubToken ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ GitHub Deployments ãŒæœ‰åŠ¹ã«ãªã‚‹
      # - "Optional: Enable this if you want to have GitHub Deployments triggered"
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          # GitHub Deployments ã‚’æœ‰åŠ¹åŒ–
          # åŠ¹æœ: GitHub UI ã§ãƒ‡ãƒ—ãƒ­ã‚¤å±¥æ­´ã‚’ç¢ºèªå¯èƒ½ã€ãƒ‡ãƒ—ãƒ­ã‚¤ URL ãŒè¡¨ç¤ºã•ã‚Œã‚‹
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        id: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ PR ã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæˆåŠŸ/å¤±æ•—ä¸¡æ–¹ï¼‰
      # æ ¹æ‹ : GitHub Actions ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ - å¸¸ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›
      # always() ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆã‚‚å®Ÿè¡Œã•ã‚Œã‚‹
      - name: Comment deployment status on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const status = '${{ job.status }}';
            const deploymentUrl = '${{ steps.deploy.outputs.deployment-url }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            let body;
            if (status === 'success' && deploymentUrl) {
              body = `âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†**\n\nğŸ”— ${deploymentUrl}`;
            } else if (status === 'success') {
              body = `âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€URL ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\n[ãƒ­ã‚°ã‚’ç¢ºèª](${runUrl})`;
            } else {
              body = `âŒ **ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—**\n\n[ãƒ­ã‚°ã‚’ç¢ºèª](${runUrl})ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
      # æ ¹æ‹ : GitHub Actions ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ - ãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“æ€§å‘ä¸Š
      # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã« .nextã€.open-nextã€.contentlayer ã‚’ç¢ºèªã§ãã‚‹
      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.sha }}
          path: |
            .next/
            .open-next/
            .contentlayer/
          retention-days: 7
