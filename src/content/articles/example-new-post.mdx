---
title: "Next.js typedRoutes: 完全型安全なルーティングの実現"
description: Next.js 15で追加された新機能とパフォーマンス改善について詳しく解説します。自動生成テスト用変更。
date: "2024-01-15"
image: /_static/articles/blog-post-1.jpg
authors:
  - kai
categories:
  - nextjs
  - supabase
related:
  - deploying-next-apps
  - server-client-components
published: true
---

Next.js の `typedRoutes` 機能は、アプリケーションのルーティングに完全な型安全性をもたらす画期的な機能です。従来のルーティングでは文字列ベースのパスを使用していたため、タイポや存在しないルートへのリンクといった問題が発生しがちでした。`typedRoutes` はこれらの問題を解決し、開発時にルートの存在をTypeScriptの型システムで検証できるようにします。

<Callout type="info" twClass="mt-5">
typedRoutes は Next.js で experimentalフラグから正式機能に昇格しており、本番環境でも安心して使用できます。
</Callout>

## typedRoutes とは

`typedRoutes` は、Next.js のファイルベースルーティングシステムと TypeScript の型システムを連携させ、存在するルートに対してのみナビゲーションできるよう制限する機能です。これにより、開発時に存在しないルートへのリンクを防ぎ、リファクタリング時のルート変更も安全に行えるようになります。

## セットアップ方法

### 1. Next.js 設定ファイルでの有効化

まず、`next.config.ts`（または `next.config.js`）で `typedRoutes` を有効にします：

```typescript title="next.config.ts"
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  typedRoutes: true,
};

export default nextConfig;
```

<Callout type="info" twClass="mt-0">
以前は `experimental.typedRoutes` として提供されていましたが、現在は `typedRoutes` として正式機能になっています。
</Callout>

### 2. TypeScript プロジェクトであることの確認

`typedRoutes` 機能を使用するには、プロジェクトが TypeScript を使用している必要があります。`tsconfig.json` が存在し、適切に設定されていることを確認してください。

## 型安全の仕組み

### 自動生成される型定義ファイル

`typedRoutes` を有効にすると、Next.js はビルド時に`.next/types/`ディレクトリに型定義ファイルを自動生成します：

#### routes.d.ts - ルート型の定義

```typescript
// This file is generated automatically by Next.js
// Do not edit this file manually

type AppRoutes = "/" | "/about" | "/products" | "/contact"
type PageRoutes = never
type LayoutRoutes = "/"
type RedirectRoutes = never
type RewriteRoutes = never
type Routes = AppRoutes | PageRoutes | LayoutRoutes | RedirectRoutes | RewriteRoutes

interface ParamMap {
  "/": {}
  "/about": {}
  "/products": {}
  "/contact": {}
}

export type ParamsOf<Route extends Routes> = ParamMap[Route]
```

この型定義により、以下が実現されます：

- **AppRoutes**: アプリケーション内の全ルートの Union Type
- **ParamMap**: 各ルートが持つパラメータの型定義
- **ParamsOf**: 特定のルートのパラメータ型を取得するヘルパー型

#### link.d.ts - Next.js API の型拡張

```typescript
declare module 'next/link' {
  export type LinkProps<RouteInferType> = LinkRestProps & {
    href: __next_route_internal_types__.RouteImpl<RouteInferType> | UrlObject
  }

  export default function Link<RouteType>(props: LinkProps<RouteType>): JSX.Element
}

declare module 'next/navigation' {
  interface AppRouterInstance extends OriginalAppRouterInstance {
    push<RouteType>(href: __next_route_internal_types__.RouteImpl<RouteType>, options?: NavigateOptions): void
    replace<RouteType>(href: __next_route_internal_types__.RouteImpl<RouteType>, options?: NavigateOptions): void
    prefetch<RouteType>(href: __next_route_internal_types__.RouteImpl<RouteType>): void
  }
}
```

この型拡張により、`Link` コンポーネントや `useRouter` フックの引数が型チェックされるようになります。

<Callout type="info" twClass="mt-0">
これらの型定義ファイルは Next.js によって自動生成されるため、手動で編集してはいけません。ファイル構造の変更があった場合、自動的に再生成されます。
</Callout>

## 実際の使用方法

### Link コンポーネントでの型安全なナビゲーション

```typescript filename="src/app/page.tsx"
import Link from "next/link";

export default function Home() {
  return (
    <div>
      {/* ✅ 正しい - 存在するルート */}
      <Link href="/">Home</Link>
      <Link href="/about">About</Link>
      
      {/* ❌ エラー - 存在しないルート */}
      <Link href="/non-existent">
        This will cause a TypeScript error
      </Link>
    </div>
  );
}
```

### useRouter での型安全なプログラマティックナビゲーション

```typescript filename="src/components/Navigation.tsx"
'use client'

import { useRouter } from 'next/navigation';

export default function Navigation() {
  const router = useRouter();

  const handleNavigation = () => {
    // ✅ 正しい - 存在するルート
    router.push('/about');
    
    // ❌ エラー - 存在しないルート
    // router.push('/invalid-route'); // TypeScript エラーが発生
  };

  return (
    <button onClick={handleNavigation}>
      Navigate to About
    </button>
  );
}
```

### redirect 関数での型安全なリダイレクト

```typescript filename="src/app/api/auth/route.ts"
import { redirect } from 'next/navigation';

export async function GET() {
  const isAuthenticated = await checkAuthentication();
  
  if (!isAuthenticated) {
    // ✅ 正しい - 存在するルート
    redirect('/login');
  }
  
  // ❌ エラー - 存在しないルート
  // redirect('/non-existent-page'); // TypeScript エラーが発生
  
  return new Response('Authenticated');
}
```

### 動的ルートでの型安全性

動的ルート（例：`/blog/[slug]`）も完全にサポートされています：

```typescript
// app/blog/[slug]/page.tsx があるとする

// 自動生成される型
type AppRoutes = "/" | "/blog/[slug]"

interface ParamMap {
  "/": {}
  "/blog/[slug]": { slug: string }
}

// 使用例
export default function BlogPost({ params }: PageProps<'/blog/[slug]'>) {
  // params.slug は string 型として推論される
  const { slug } = await params;
  return <div>Blog post: {slug}</div>;
}
```

<Callout type="info" twClass="mt-0">
動的ルートのパラメータも適切に型付けされ、存在しないパラメータにアクセスしようとするとTypeScriptエラーが発生します。
</Callout>

## typedRoutes がもたらすメリット

### 1. 開発時のエラー検出

存在しないルートへのリンクやナビゲーションを開発時に検出できます：

```typescript
// TypeScript が以下のエラーを検出します
<Link href="/typo-in-route">Link</Link>
// Error: Type '"/typo-in-route"' is not assignable to type '...'
```

### 2. リファクタリングの安全性

ルート構造を変更した場合、影響を受ける全ての箇所を TypeScript が教えてくれます：

```typescript
// /about ページを /about-us に変更した場合
// 古いルートを参照している全ての箇所でエラーが発生
<Link href="/about">About</Link> // ❌ TypeScript エラー
```

### 3. IDE でのオートコンプリート

TypeScript の恩恵により、IDE でルートのオートコンプリートが利用できます：

```typescript
<Link href="/" // IDE が利用可能なルートを提案
```

### 4. 型安全なパラメータアクセス

動的ルートのパラメータに型安全にアクセスできます：

```typescript
// /product/[id]/page.tsx
export default function Product({ params }: PageProps<'/product/[id]'>) {
  const { id } = await params; // id は string 型
  // params.nonExistent // ❌ TypeScript エラー
}
```

## 注意点と制限事項

### 1. 外部 URL は型チェック対象外

外部 URL や相対パス（`../`など）は型チェックの対象外です：

```typescript
// これらは型チェックされません
<Link href="https://external-site.com">External</Link>
<Link href="../relative-path">Relative</Link>
```

### 2. 動的な文字列結合

実行時に動的に生成されるルートは型チェックできません：

```typescript
const dynamicRoute = `/user/${userId}`;
<Link href={dynamicRoute}>User</Link> // 型チェックされない
```

<Callout type="info" twClass="mt-0">
動的ルートを使用する場合は、テンプレートリテラルよりも適切な型付きの動的ルートページを作成することを推奨します。
</Callout>

### 3. ビルド時の型生成

型定義ファイルはビルド時に生成されるため、ファイル構造を変更した後は適切にビルドプロセスを実行する必要があります。

## まとめ

Next.js の `typedRoutes` 機能は、モダンな Web アプリケーション開発において重要な型安全性をルーティングシステムにもたらします。この機能により：

- **開発効率の向上**: 型エラーによる早期問題検出
- **保守性の向上**: リファクタリング時の安全性確保  
- **開発体験の向上**: IDE でのオートコンプリートとエラー表示

<Callout type="info" twClass="mt-0">
typedRoutes は Next.js の App Router と組み合わせることで最大の効果を発揮します。TypeScript プロジェクトでは積極的に活用することを強く推奨します。
</Callout>

現代のフロントエンド開発では、型安全性が品質とデベロッパーエクスペリエンスの向上において不可欠な要素となっています。`typedRoutes` は、この重要な側面をルーティングシステムにまで拡張し、より堅牢で保守しやすいアプリケーションの構築を可能にします。
